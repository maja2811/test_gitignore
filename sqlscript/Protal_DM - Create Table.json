{
	"name": "Protal_DM - Create Table",
	"properties": {
		"folder": {
			"name": "ivu/Serverless"
		},
		"content": {
			"query": "/*** create table ***************************************************************/\nIF EXISTS ( SELECT * FROM sys.external_tables WHERE [name] = 'Protal_DM' )\n\tDROP EXTERNAL TABLE IVU.Protal_DM\nGO\n\n\tCREATE EXTERNAL TABLE IVU.Protal_DM \n\t\tWITH (\n\t\tLOCATION = 'IVU/DM/Protal_DM',\n\t\tDATA_SOURCE = [zone-connected],\n\t\tFILE_FORMAT = [ParquetFormat]\n\t\t)\n\tAS\nSELECT [koeredoegn]\n    ,[tog_nr]\n    ,[vogntur_start_station_UIC]\n    ,[vogntur_start_station_fork]\n    ,[vogntur_end_station_UIC]\n    ,[vogntur_end_station_fork]\n    ,[vogntur_start_tid]\n    ,[vogntur_end_tid]\n    ,[vogntur_distance]\n    ,[station_aktuel_UIC]\n    ,[station_aktuel_fork]\n    ,[station_sekvens]\n    ,tog_sekvens\n    ,[ank_tid]\n    ,[afg_tid]\n    ,[station_forrige]\n    ,[station_naeste]\n    ,[statmlm_next_distance]\n    ,[stop_type]\n    ,[spor]\n    ,[tog_kategori]\n    ,[Koereplan72timer]\n    ,[saet_nr]\n    ,[litra_type]\n    ,[litra_nr]\n    ,[trip_type]\n    ,[pre_tog_nr]\n    ,[pre_koeredoegn]\n    ,[pre_ank_tid]\n    ,[pre_ank_timestamp]\n    ,[post_tog_nr]\n    ,[post_koeredoegn]\n    ,[post_afg_tid]\n    ,[post_afg_timestamp]\nFROM (\n\t(SELECT \n\t\t[validity_validityDate] AS koeredoegn,\n\t\t[trainGroup_externalNumber] AS tog_nr,\n\t\t[beginLocation_externalNumber] AS vogntur_start_station_UIC,\n\t\t[beginLocation_abbreviation] AS vogntur_start_station_fork,\n\t\t[endLocation_externalNumber] AS vogntur_end_station_UIC,\n\t\t[endLocation_abbreviation] AS vogntur_end_station_fork,\n\t\t--[trainGroup_startDate],\n\t\t[trainSection_beginTime] AS vogntur_start_tid,\n\t\t--[trainSection_beginDayOffset],\n\t\t--[BeginTimestamp] AS tog_start_timestamp,\n\t\t[trainSection_endTime] AS vogntur_end_tid,\n\t\t--[trainSection_endDayOffset],\n\t\t--[EndTimestamp] AS tog_end_timestamp,\n\t\t[trainSection_distance] AS vogntur_distance,\n\t\t[location_externalNumber] AS station_aktuel_UIC,\n\t\t[location_abbreviation] AS station_aktuel_fork,\n\t\t[Station_sequence] AS station_sekvens,\n\t\tROW_NUMBER() OVER (PARTITION BY validity_validityDate, trainGroup_externalNumber  ORDER BY trainSection_beginTime, station_sequence  ) AS tog_sekvens,\n\t\t[itineraryStop_operationalArrivalTime] AS ank_tid,\n\t\t--[itineraryStop_operationalArrivalDayOffset],\n\t\t--[ArrivalTimestamp],\n\t\t[itineraryStop_operationalDepartureTime] AS afg_tid,\n\t\t--[itineraryStop_operationalDepartureDayOffset],\n\t\t[DepartureTimestamp],\n\t\t[Station_from] AS station_forrige,\n\t\t--[Station_from_externalNumber],\n\t\t[Station_to] AS station_naeste,\n\t\t--[Station_to_externalNumber],\n\t\t[itineraryStop_distance] AS statmlm_next_distance,\n\t\tCASE [itineraryStop_passthrough] WHEN 0 THEN 'STOP' ELSE 'GENNEMKOER' END AS stop_type,\n\t\t[itineraryStop_track] AS spor,\n\t\t--[itineraryStop_networkTrainNumber],\n\t\t[itineraryStop_trainCategory] AS tog_kategori,\n\t\t[Koereplan72timer]\n\t\t--[SysValidFrom],\n\t\t--[SysValidTo]\n\tFROM\n    \tOPENROWSET(\n\t        BULK 'https://datalakegen2atlasdev.dfs.core.windows.net/zone-connected/IVU/FR_Itinerary.csv',\n    \t    FORMAT = 'CSV',\n        \tHEADER_ROW = TRUE,\n        \tFIELDTERMINATOR = ';',\n\t        PARSER_VERSION = '2.0'\n    \t) \n\tWITH (\n\t\t[validity_validityDate] date,\n\t\t[trainGroup_externalNumber] bigint,\n\t\t[beginLocation_externalNumber] bigint,\n\t\t[beginLocation_abbreviation] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[endLocation_externalNumber] bigint,\n\t\t[endLocation_abbreviation] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[trainGroup_startDate] date,\n\t\t[trainSection_beginTime] time(0),\n\t\t[trainSection_beginDayOffset] bigint,\n\t\t[BeginTimestamp] datetime2(0),\n\t\t[trainSection_endTime] time(0),\n\t\t[trainSection_endDayOffset] bigint,\n\t\t[EndTimestamp] datetime2(0),\n\t\t[trainSection_distance] bigint,\n\t\t[location_externalNumber] bigint,\n\t\t[location_abbreviation] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[Station_sequence] bigint,\n\t\t[itineraryStop_operationalArrivalTime] time(0),\n\t\t[itineraryStop_operationalArrivalDayOffset] bigint,\n\t\t[ArrivalTimestamp] datetime2(0),\n\t\t[itineraryStop_operationalDepartureTime] time(0),\n\t\t[itineraryStop_operationalDepartureDayOffset] bigint,\n\t\t[DepartureTimestamp] datetime2(0),\n\t\t[Station_from] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[Station_from_externalNumber] bigint ,\n\t\t[Station_to] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[Station_to_externalNumber] bigint,\n\t\t[itineraryStop_distance] bigint,\n\t\t[itineraryStop_passthrough] bigint,\n\t\t[itineraryStop_track] nvarchar(4000),\n\t\t[itineraryStop_networkTrainNumber] bigint,\n\t\t[itineraryStop_trainCategory] nvarchar(4000),\n\t\t[Koereplan72timer] bigint,\n\t\t[SysValidFrom] datetime2(0),\n\t\t[SysValidTo] datetime2(0)\n\t ) i\n) AS Itinerary\n\t\nLEFT JOIN (\n\tSELECT\n\t\t[validity_validityDate],\n\t\t[trainGroup_externalNumber],\n\t\t[beginLocation_externalNumber],\n\t\t[endLocation_externalNumber],\n\t\t[formationElement_carSortingNumber] AS saet_nr,\n\t\t[vehicle_type] AS litra_type,\n\t\t[vehicle_vehicleNumber] AS litra_nr,\n\t\t[trip_tripType] AS trip_type,\n\t\t[predecessor_trainKey] AS pre_tog_nr,\n\t\t[predecessor_validityDate] AS pre_koeredoegn,\n\t\t[predecessor_arrivalTime] AS pre_ank_tid,\n\t\t[predecessor_arrivalTimestamp] AS pre_ank_timestamp,\n\t\t[successor_trainKey] AS post_tog_nr,\n\t\t[successor_validityDate] AS post_koeredoegn,\n\t\t[successor_departureTime] AS post_afg_tid,\n\t\t[successor_departureTimetamp] AS post_afg_timestamp\n\tFROM\n   \tOPENROWSET(\n       \tBULK 'https://datalakegen2atlasdev.dfs.core.windows.net/zone-connected/IVU/FR_VehicleTrip.csv',\n       \tFORMAT = 'CSV',\n       \tHEADER_ROW = TRUE,\n       \tFIELDTERMINATOR = ';',\n       \tPARSER_VERSION = '2.0'\n\t)\n\tWITH (\n\t\t[validity_validityDate] date,\n\t\t[trainGroup_externalNumber] bigint,\n\t\t[beginLocation_externalNumber] bigint,\n\t\t[beginLocation_abbreviation] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[endLocation_externalNumber] bigint,\n\t\t[endLocation_abbreviation] nvarchar(4000) COLLATE Latin1_General_100_BIN2_UTF8,\n\t\t[trainGroup_startDate] date,\n\t\t[trainSection_beginTime] time(0),\n\t\t[trainSection_beginDayOffset] bigint,\n\t\t[BeginTimestamp] datetime2(0),\n\t\t[trainSection_endTime] time(0),\n\t\t[trainSection_endDayOffset] bigint,\n\t\t[EndTimestamp] datetime2(0),\n\t\t[trainSection_distance] bigint,\n\t\t[formationElement_elementIndexInFormation] bigint,\n\t\t[formationElement_vehicleWorkingIndexInFormation] bigint,\n\t\t[formationElement_carSortingNumber] bigint,\n\t\t[vehicle_type] nvarchar(4000),\n\t\t[vehicleType_abbreviation] nvarchar(4000),\n\t\t[vehicle_vehicleNumber] bigint,\n\t\t[vehicle_externalVehicleNumber] bigint,\n\t\t[vehicleWorking_type] nvarchar(4000),\n\t\t[vehicleWorking_description] nvarchar(4000),\n\t\t[trip_externalTripNumber] bigint,\n\t\t[trip_tripType] nvarchar(4000),\n\t\t[trip_route] nvarchar(4000),\n\t\t[trip_tripClass] nvarchar(4000),\n\t\t[predecessor_trainKey] bigint,\n\t\t[predecessor_validityDate] date,\n\t\t[predecessor_dayOffset] bigint,\n\t\t[predecessor_arrivalTime] time(0),\n\t\t[predecessor_arrivalTimestamp] datetime2(0),\n\t\t[predecessor_preDescription] nvarchar(4000),\n\t\t[successor_trainKey] bigint,\n\t\t[successor_validityDate] date,\n\t\t[successor_dayOffset] bigint,\n\t\t[successor_departureTime] time(0),\n\t\t[successor_departureTimetamp] datetime2(0),\n\t\t[successor_postDescription] nvarchar(4000),\n\t\t[Koereplan72timer] bigint,\n\t\t[SysValidFrom] datetime2(0),\n\t\t[SysValidTo] datetime2(0)\n\t) v\n) AS VehicleTrip\n\tON  Itinerary.koeredoegn = VehicleTrip.validity_validityDate\n\tAND Itinerary.tog_nr = VehicleTrip.trainGroup_externalNumber\n\tAND Itinerary.vogntur_start_station_UIC = VehicleTrip.beginLocation_externalNumber\n\tAND Itinerary.vogntur_end_station_UIC = VehicleTrip.endLocation_externalNumber\n)\n\nGO\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "atlas-srvless-sql-dev",
				"poolName": "Built-in"
			},
			"resultLimit": -1
		},
		"type": "SqlQuery"
	}
}